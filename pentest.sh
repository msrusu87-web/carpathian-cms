#!/bin/bash
# Penetration Testing Script for Carpathian CMS
# Tests common vulnerabilities

TARGET="https://carphatian.ro"
REPORT="/home/ubuntu/live-carphatian/pentest-report-$(date +%Y%m%d-%H%M%S).txt"

echo "=== Carpathian CMS Penetration Test ===" | tee "$REPORT"
echo "Target: $TARGET" | tee -a "$REPORT"
echo "Date: $(date)" | tee -a "$REPORT"
echo "" | tee -a "$REPORT"

# Test 1: SQL Injection
echo "1. Testing SQL Injection..." | tee -a "$REPORT"
curl -s "$TARGET/search?q=test' OR '1'='1" | grep -q "error" && \
    echo "   [!] Possible SQL injection vulnerability" | tee -a "$REPORT" || \
    echo "   [✓] SQL injection test passed" | tee -a "$REPORT"

# Test 2: XSS
echo "" | tee -a "$REPORT"
echo "2. Testing XSS..." | tee -a "$REPORT"
response=$(curl -s "$TARGET/search?q=<script>alert('XSS')</script>")
if echo "$response" | grep -q "<script>alert('XSS')</script>"; then
    echo "   [!] Possible XSS vulnerability" | tee -a "$REPORT"
else
    echo "   [✓] XSS test passed" | tee -a "$REPORT"
fi

# Test 3: Security Headers
echo "" | tee -a "$REPORT"
echo "3. Checking Security Headers..." | tee -a "$REPORT"
headers=$(curl -sI "$TARGET")
echo "$headers" | grep -q "X-Frame-Options" && \
    echo "   [✓] X-Frame-Options present" | tee -a "$REPORT" || \
    echo "   [!] X-Frame-Options missing" | tee -a "$REPORT"
echo "$headers" | grep -q "X-Content-Type-Options" && \
    echo "   [✓] X-Content-Type-Options present" | tee -a "$REPORT" || \
    echo "   [!] X-Content-Type-Options missing" | tee -a "$REPORT"
echo "$headers" | grep -q "Strict-Transport-Security" && \
    echo "   [✓] HSTS present" | tee -a "$REPORT" || \
    echo "   [!] HSTS missing" | tee -a "$REPORT"

# Test 4: Directory Traversal
echo "" | tee -a "$REPORT"
echo "4. Testing Directory Traversal..." | tee -a "$REPORT"
status=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET/../../../etc/passwd")
if [ "$status" = "200" ]; then
    echo "   [!] Possible directory traversal vulnerability" | tee -a "$REPORT"
else
    echo "   [✓] Directory traversal test passed" | tee -a "$REPORT"
fi

# Test 5: Sensitive File Exposure
echo "" | tee -a "$REPORT"
echo "5. Testing for exposed sensitive files..." | tee -a "$REPORT"
for file in ".env" ".git/config" "composer.json" "phpinfo.php" "info.php"; do
    status=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET/$file")
    if [ "$status" = "200" ]; then
        echo "   [!] $file is publicly accessible" | tee -a "$REPORT"
    else
        echo "   [✓] $file is protected" | tee -a "$REPORT"
    fi
done

# Test 6: SSL/TLS Configuration
echo "" | tee -a "$REPORT"
echo "6. Testing SSL/TLS..." | tee -a "$REPORT"
if command -v testssl.sh &> /dev/null; then
    testssl.sh --quiet "$TARGET" >> "$REPORT" 2>&1
else
    echo "   [!] testssl.sh not installed (recommended: git clone https://github.com/drwetter/testssl.sh)" | tee -a "$REPORT"
fi

# Test 7: Rate Limiting
echo "" | tee -a "$REPORT"
echo "7. Testing Rate Limiting..." | tee -a "$REPORT"
echo "   Sending 50 rapid requests..." | tee -a "$REPORT"
blocked=0
for i in {1..50}; do
    status=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET/")
    [ "$status" = "429" ] && ((blocked++))
done
if [ $blocked -gt 0 ]; then
    echo "   [✓] Rate limiting active ($blocked requests blocked)" | tee -a "$REPORT"
else
    echo "   [!] No rate limiting detected" | tee -a "$REPORT"
fi

# Test 8: Bot Detection
echo "" | tee -a "$REPORT"
echo "8. Testing Bot Detection..." | tee -a "$REPORT"
status=$(curl -s -o /dev/null -w "%{http_code}" -A "BadBot" "$TARGET/")
if [ "$status" = "403" ] || [ "$status" = "429" ]; then
    echo "   [✓] Bad bots are blocked" | tee -a "$REPORT"
else
    echo "   [!] Bad bots not blocked" | tee -a "$REPORT"
fi

echo "" | tee -a "$REPORT"
echo "Penetration test complete!" | tee -a "$REPORT"
echo "Report saved to: $REPORT" | tee -a "$REPORT"
